{% extends "base.html" %}

{% block title %}Manage User: {{ target_user.username.as_deref().unwrap_or("User") }} // NIJIKA Staff{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
        <a href="/staff/users" style="color: var(--text-muted); text-decoration: none; font-size: 0.8rem;">&larr; Back to Users</a>
    </div>
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 1.5rem;">
            {% if let Some(avatar) = target_user.avatar_url %}
                <img src="{{ avatar }}" alt="Avatar" style="width: 64px; height: 64px; border-radius: 50%;">
            {% else %}
                <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--panel-bg); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--text-muted);">
                    {{ target_user.username.as_deref().unwrap_or("U").get(0..1).unwrap_or("U") }}
                </div>
            {% endif %}
            <div>
                <h1>{{ target_user.username.as_deref().unwrap_or("Anonymous User") }}</h1>
                <div style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-muted); font-size: 0.9rem;">
                    <span>{{ target_user.email.as_deref().unwrap_or("No email") }}</span>
                    <span>&bull;</span>
                    <span>ID: {{ target_user.id }}</span>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 1rem;">
            <form action="/staff/users/{{ target_user.id }}/toggle-status" method="POST">
                {% if target_user.is_active %}
                    <button type="submit" class="btn btn-outline" style="border-color: var(--danger); color: var(--danger);">Suspend User</button>
                {% else %}
                    <button type="submit" class="btn btn-outline" style="border-color: var(--success); color: var(--success);">Activate User</button>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
    <div class="panel">
        <h3>Account Overview</h3>
        <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem;">
                <span style="color: var(--text-muted);">Role</span>
                <span style="font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">{{ target_user.role_name() }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem;">
                <span style="color: var(--text-muted);">Status</span>
                <span style="font-weight: 600; color: {% if target_user.is_active %}var(--success){% else %}var(--danger){% endif %};">
                    {% if target_user.is_active %}ACTIVE{% else %}SUSPENDED{% endif %}
                </span>
            </div>
            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem;">
                <span style="color: var(--text-muted);">Credits</span>
                <span style="font-weight: 600; font-family: var(--font-mono); color: var(--accent-color);">${{ target_user.formatted_credits() }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-muted);">Member Since</span>
                <span style="font-weight: 600;">{{ target_user.created_at.format("%b %d, %Y") }}</span>
            </div>
        </div>
    </div>

    {% if user.is_admin() %}
    <div class="panel" style="border-left: 4px solid var(--accent-color);">
        <h3>Adjust Credits</h3>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1.5rem;">Add (positive) or remove (negative) credits from this user.</p>
        <form action="/staff/users/{{ target_user.id }}/adjust-credits" method="POST" style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label style="display: block; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5rem; color: var(--text-muted);">Amount ($)</label>
                <input type="number" name="amount" step="0.01" required placeholder="5.00" style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: 4px; color: white; font-family: var(--font-mono);">
            </div>
            <div>
                <label style="display: block; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5rem; color: var(--text-muted);">Reason / Description</label>
                <input type="text" name="reason" required placeholder="Customer support adjustment" style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: 4px; color: white;">
            </div>
            <button type="submit" class="btn" style="margin-top: 0.5rem;">Apply Adjustment</button>
        </form>

        <div style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.5rem;">
            <h3>Role Management</h3>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1.5rem;">Change this user's permissions level.</p>
            <form action="/staff/users/{{ target_user.id }}/change-role" method="POST" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5rem; color: var(--text-muted);">New Role</label>
                    <select name="role" style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: 4px; color: white;">
                        <option value="user" {% if target_user.role_name() == "user" %}selected{% endif %}>User (Standard)</option>
                        <option value="moderator" {% if target_user.role_name() == "moderator" %}selected{% endif %}>Moderator (Staff)</option>
                        <option value="admin" {% if target_user.role_name() == "admin" %}selected{% endif %}>Admin (Superuser)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-outline" style="margin-top: 0.5rem;">Update Role</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<div class="panel" style="margin-bottom: 2rem;">
    <h3>User Usage Logs (Last 50)</h3>
    <div style="overflow-x: auto; margin-top: 1rem;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <thead>
                <tr style="text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-muted);">
                    <th style="padding: 0.75rem 0.5rem;">Service</th>
                    <th style="padding: 0.75rem 0.5rem;">Status</th>
                    <th style="padding: 0.75rem 0.5rem;">Time</th>
                    <th style="padding: 0.75rem 0.5rem; text-align: right;">Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                    <td style="padding: 0.75rem 0.5rem;">
                        <div style="font-weight: 600;">{{ log.service }}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">{{ log.details.as_deref().unwrap_or("-") }}</div>
                    </td>
                    <td style="padding: 0.75rem 0.5rem;">
                        <span style="font-size: 0.7rem; font-weight: bold; text-transform: uppercase;">
                            {% if log.status == "success" %}
                                <span style="color: var(--success);">Success</span>
                            {% else %}
                                <span style="color: var(--danger);">Failed</span>
                            {% endif %}
                        </span>
                    </td>
                    <td style="padding: 0.75rem 0.5rem; color: var(--text-muted);">{{ log.formatted_time() }}</td>
                    <td style="padding: 0.75rem 0.5rem; text-align: right; font-family: var(--font-mono);">
                        -${{ log.formatted_credits() }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="panel">
    <h3>Transaction History (Last 50)</h3>
    <div style="overflow-x: auto; margin-top: 1rem;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <thead>
                <tr style="text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-muted);">
                    <th style="padding: 0.75rem 0.5rem;">Type</th>
                    <th style="padding: 0.75rem 0.5rem;">Description</th>
                    <th style="padding: 0.75rem 0.5rem;">Time</th>
                    <th style="padding: 0.75rem 0.5rem; text-align: right;">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                    <td style="padding: 0.75rem 0.5rem;">
                        <span style="font-size: 0.7rem; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; 
                            {% if tx.type == "charge" %} background: rgba(255, 77, 77, 0.1); color: var(--danger);
                            {% elif tx.type == "bonus" %} background: rgba(0, 230, 115, 0.1); color: var(--success);
                            {% elif tx.type == "deposit" %} background: rgba(0, 153, 255, 0.1); color: var(--accent-color);
                            {% else %} background: rgba(255,255,255,0.05); color: var(--text-muted);
                            {% endif %}">
                            {{ tx.type }}
                        </span>
                    </td>
                    <td style="padding: 0.75rem 0.5rem;">{{ tx.description.as_deref().unwrap_or("-") }}</td>
                    <td style="padding: 0.75rem 0.5rem; color: var(--text-muted);">{{ tx.formatted_time() }}</td>
                    <td style="padding: 0.75rem 0.5rem; text-align: right; font-family: var(--font-mono); font-weight: 600; 
                        {% if tx.amount.is_sign_positive() %} color: var(--success); {% else %} color: var(--danger); {% endif %}">
                        {% if tx.amount.is_sign_positive() %}+{% endif %}{{ tx.formatted_amount() }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
